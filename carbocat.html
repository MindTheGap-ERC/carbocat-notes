<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>CarboKitten</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="light.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
<script>
// ScrollSpy snippet from Bramus Van Damme (https://www.bram.us/)
// MIT License.
window.addEventListener('DOMContentLoaded', () => {
	const observer = new IntersectionObserver(entries => {
		entries.forEach(entry => {
			const id = entry.target.getAttribute('id');
      const nav = document.querySelector(`nav li a[href="#${id}"]`)
      if (nav) {
        if (entry.intersectionRatio > 0) {
          nav.parentElement.classList.add('active');
        } else {
          nav.parentElement.classList.remove('active');
			} }
		});
	});

	// Track all sections that have an `id` applied
	document.querySelectorAll('section[id]').forEach((section) => {
		observer.observe(section);
	});
});

function openTab(evt, cityName) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tab");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}
</script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">CarboKitten</h1>
<p class="subtitle">CarboCAT in Julia</p>
</header>

<div class="row">
<div class="col-3 col-s-6" id="contents">
<ul>
<li><a href="bosscher-1992.html"></a></li>
<li><a href="carbocat.html">CarboCAT in Julia</a></li>
<li><a href="carbocat-transport.html">Sediment Transport</a></li>
<li><a href="daisy-world.html">reading notes on Wood’s 2008
review</a></li>
<li><a href="index.html">project notes</a></li>
<li><a href="intro-to-julia.html"></a></li>
<li><a href="random-fields.html"></a></li>
<li><a href="stencils.html">stencil operations in Julia</a></li>
<li><a href="utility.html">utility functions</a></li>
</ul>
</div>
<div class="col-6 col-s-9" id="main">
<section id="carbocat-2013" class="level1">
<h1>CarboCAT 2013</h1>
<p>CarboCAT is primarily based on a very simple cellular automaton (CA).
We may explore this CA as a first step in implementing the model in
Julia.</p>
<div class="named-code-block">
<div class="code-block-title">
file:src/Burgess2013.jl
</div>
<div class="sourceCode" id="cb1"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> Burgess2013</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">&quot;Burgess2013/Config.jl&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">&quot;Burgess2013/CA.jl&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">&quot;Burgess2013/Production.jl&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">&quot;Burgess2013/Transport.jl&quot;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<div class="named-code-block">
<div class="code-block-title">
file:src/Burgess2013/Config.jl
</div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> Config</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Species</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    viability_range<span class="op">::</span><span class="dt">Tuple{Int, Int}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    activation_range<span class="op">::</span><span class="dt">Tuple{Int, Int}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    maximum_growth_rate<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    extinction_coefficient<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    saturation_intensity<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">Iₖ</span>(s<span class="op">::</span><span class="dt">Species</span>) <span class="op">=</span> s.saturation_intensity</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">k</span>(s<span class="op">::</span><span class="dt">Species</span>) <span class="op">=</span> s.extinction_coefficient</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">gₘ</span>(s<span class="op">::</span><span class="dt">Species</span>) <span class="op">=</span> s.maximum_growth_rate</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<section id="cellular-automaton" class="level2">
<h2>Cellular Automaton</h2>
<p>The paper talks about cycling the order of preference for occupying
an empty cell at each iteration. This means that the rules change
slighly every iteration.</p>
<div class="named-code-block">
<div class="code-block-title">
«cycle-permutation»
</div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cycle_permutation</span>(n_species<span class="op">::</span><span class="dt">Int</span>) <span class="op">=</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">circshift</span>(<span class="fl">1</span><span class="op">:</span>n_species, x) <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">Iterators</span>.<span class="fu">countfrom</span>(<span class="fl">0</span>))</span></code></pre></div>
</div>
<p>The <code>stencil</code> function has an <code>args...</code>
variadic arguments that are forwarded to the given rule. This means we
can create a <code>rules</code> function that we pass the preference
order as a second argument.</p>
<div class="named-code-block">
<div class="code-block-title">
«burgess2013-rules»
</div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rules</span>(neighbourhood<span class="op">::</span><span class="dt">Matrix{Int}</span>, order<span class="op">::</span><span class="dt">Vector{Int}</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    cell_species <span class="op">=</span> neighbourhood[<span class="fl">3</span>, <span class="fl">3</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">neighbour_count</span>(species) <span class="op">=</span> <span class="fu">sum</span>(neighbourhood <span class="op">.==</span> species)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cell_species <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> species <span class="kw">in</span> order</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="fu">neighbour_count</span>(species)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fl">6</span> <span class="op">&lt;=</span> n <span class="op">&amp;&amp;</span> n <span class="op">&lt;=</span> <span class="fl">10</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> species</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="fu">neighbour_count</span>(cell_species) <span class="op">-</span> <span class="fl">1</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">4</span> <span class="op">&lt;=</span> n <span class="op">&amp;&amp;</span> n <span class="op">&lt;=</span> <span class="fl">10</span> ? cell_species <span class="op">:</span> <span class="fl">0</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<p>This function is not yet adaptible to the given rule set. Such a
modification is not so hard to make.</p>
<p>The paper talks about a 50x50 grid initialized with uniform random
values.</p>
<div class="named-code-block">
<div class="code-block-title">
file:src/Burgess2013/CA.jl
</div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> CA</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MindTheGap.Stencil</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>cycle<span class="op">-</span>permutation<span class="op">&gt;&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>burgess2013<span class="op">-</span>rules<span class="op">&gt;&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run</span>(<span class="op">::</span><span class="dt">Type{B}</span>, init<span class="op">::</span><span class="dt">Matrix{Int}</span>, n_species<span class="op">::</span><span class="dt">Int</span>) <span class="kw">where</span> {B <span class="op">&lt;:</span><span class="dt"> Boundary{2}</span>}</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Channel</span><span class="dt">{Matrix{Int}}</span>() <span class="cf">do</span> ch</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Int}</span>(<span class="cn">undef</span>, <span class="fu">size</span>(init))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">put!</span>(ch, init)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        stencil_op <span class="op">=</span> <span class="fu">stencil</span>(<span class="dt">Int</span>, B, (<span class="fl">5</span>, <span class="fl">5</span>), rules)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> perm <span class="kw">in</span> <span class="fu">cycle_permutation</span>(n_species)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stencil_op</span>(init, target, perm)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            init, target <span class="op">=</span> target, init</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">put!</span>(ch, init)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<p>First, let us reproduce Figure 3 in Burgess 2013.</p>
<figure>
<img src="fig/burgess2013-fig3.svg" alt="First 8 generations" />
<figcaption aria-hidden="true">First 8 generations</figcaption>
</figure>
<p>By eye comparison seems to indicate that this CA is working the same.
I’m curious to the behaviour after more iterations. Let’s try 10, 100,
1000 and so on.</p>
<figure>
<img src="fig/burgess2013-long-times.svg" alt="Assymptotic behaviour" />
<figcaption aria-hidden="true">Assymptotic behaviour</figcaption>
</figure>
<p>The little qualitative change between 100 and 1000 iterations would
indicate that this CA remains “interesting” for a long time.</p>
<p>On my laptop I can run about 150 iterations per second with current
code. When using periodic boundaries, I get to 1500 iterations per
second, which is peculiar. A lot can still be optimized.</p>
<details>
<summary>
Plotting code
</summary>
<div class="named-code-block">
<div class="code-block-title">
file:src/figures/ca.jl
</div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MindTheGap.Burgess2013.CA</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MindTheGap.Stencil</span>: Reflected</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MindTheGap.Utility</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">GnuplotLite</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_array</span>(w<span class="op">::</span><span class="dt">Int</span>, h<span class="op">::</span><span class="dt">Int</span>, msgs; xtics<span class="op">=</span><span class="st">&quot;set xtics&quot;</span>, ytics<span class="op">=</span><span class="st">&quot;set ytics&quot;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    ch <span class="op">=</span> <span class="fu">Channel</span><span class="dt">{String}</span>() <span class="cf">do</span> ch</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> <span class="fu">Gnuplot</span>(ch)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        top_margin <span class="op">=</span> <span class="fl">0.002</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        bottom_margin <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        left_margin <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        right_margin <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        inner_margin <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        vert_inner_margin <span class="op">=</span> <span class="fl">0.025</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># h * ph + (h-1) * inner_margin + top_margin + bottom_margin = 1</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        plot_height <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> (h<span class="op">-</span><span class="fl">1</span>)<span class="op">*</span>inner_margin <span class="op">-</span> top_margin <span class="op">-</span> bottom_margin) <span class="op">/</span> h</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        plot_width <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> (w<span class="op">-</span><span class="fl">1</span>)<span class="op">*</span>vert_inner_margin <span class="op">-</span> left_margin <span class="op">-</span> right_margin) <span class="op">/</span> w</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        g <span class="op">|&gt;</span> <span class="fu">send</span>(<span class="st">&quot;set multiplot; unset xtics&quot;</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i, msg) <span class="kw">in</span> <span class="fu">enumerate</span>(msgs)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            grid_x <span class="op">=</span> (i <span class="op">-</span> <span class="fl">1</span>) <span class="op">%</span> w</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            grid_y <span class="op">=</span> (i <span class="op">-</span> <span class="fl">1</span>) <span class="op">÷</span> w</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grid_x <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                tmargin <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> top_margin <span class="op">-</span> (plot_height <span class="op">+</span> vert_inner_margin) <span class="op">*</span> grid_y</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                bmargin <span class="op">=</span> tmargin <span class="op">-</span> plot_height</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                g <span class="op">|&gt;</span> <span class="fu">send</span>(<span class="st">&quot;set tmargin at screen </span><span class="sc">$</span>(tmargin)<span class="st">; set bmargin at screen </span><span class="sc">$</span>(bmargin)<span class="st">&quot;</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                g <span class="op">|&gt;</span> <span class="fu">send</span>(ytics)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grid_x <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                g <span class="op">|&gt;</span> <span class="fu">send</span>(<span class="st">&quot;unset ytics&quot;</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grid_y <span class="op">==</span> h<span class="op">-</span><span class="fl">1</span> <span class="op">&amp;&amp;</span> grid_x <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                g <span class="op">|&gt;</span> <span class="fu">send</span>(xtics)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            lmargin <span class="op">=</span> left_margin <span class="op">+</span> (plot_width <span class="op">+</span> inner_margin) <span class="op">*</span> grid_x</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>            rmargin <span class="op">=</span> lmargin <span class="op">+</span> plot_width</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            g <span class="op">|&gt;</span> <span class="fu">send</span>(<span class="st">&quot;set lmargin at screen </span><span class="sc">$</span>(lmargin)<span class="st">; set rmargin at screen </span><span class="sc">$</span>(rmargin)<span class="st">&quot;</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            g <span class="op">|&gt;</span> msg</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        g <span class="op">|&gt;</span> <span class="fu">send</span>(<span class="st">&quot;unset multiplot&quot;</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">send</span>(<span class="fu">join</span>(ch, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>))</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot</span>(output<span class="op">::</span><span class="dt">String</span>)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    init <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">50</span>, <span class="fl">50</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="bu">Iterators</span>.<span class="fu">take</span>(CA.<span class="fu">run</span>(Reflected{<span class="fl">2</span>}, init, <span class="fl">3</span>), <span class="fl">8</span>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gnuplot</span>() <span class="cf">do</span> g</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        g <span class="op">|&gt;</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set term svg size 900, 440&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set output &#39;</span><span class="sc">$</span>(output)<span class="st">&#39;&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;load &#39;data/blue-to-red.pal&#39;&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set size square&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set xrange [0:50]; set yrange [0:50]&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;unset colorbox&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plot_array</span>(<span class="fl">4</span>, <span class="fl">2</span>, (<span class="fu">send</span>(<span class="st">&quot;data&quot;</span> <span class="op">=&gt;</span> r) <span class="op">*</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">send</span>(<span class="st">&quot;plot \$data matrix u (\$1+0.5):(\$2+0.5):3 t&#39;&#39; w image pixels&quot;</span>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                              <span class="cf">for</span> r <span class="kw">in</span> result);</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                       xtics<span class="op">=</span><span class="st">&quot;set xtics 10, 10, 50&quot;</span>,</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                       ytics<span class="op">=</span><span class="st">&quot;set ytics 10, 10, 50&quot;</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_long_times</span>(output<span class="op">::</span><span class="dt">String</span>)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    init <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">50</span>, <span class="fl">50</span>)</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">select</span>(CA.<span class="fu">run</span>(Reflected{<span class="fl">2</span>}, init, <span class="fl">3</span>), [<span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span>])</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gnuplot</span>() <span class="cf">do</span> g</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        g <span class="op">|&gt;</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set term svg size 900, 240&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set output &#39;</span><span class="sc">$</span>(output)<span class="st">&#39;&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;load &#39;data/blue-to-red.pal&#39;&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set size square&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;set xrange [0:50]; set yrange [0:50]&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>            <span class="fu">send</span>(<span class="st">&quot;unset colorbox&quot;</span>) <span class="op">|&gt;</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plot_array</span>(<span class="fl">3</span>, <span class="fl">1</span>, (<span class="fu">send</span>(<span class="st">&quot;data&quot;</span> <span class="op">=&gt;</span> r) <span class="op">*</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">send</span>(<span class="st">&quot;plot \$data matrix u (\$1+0.5):(\$2+0.5):3 t&#39;&#39; w image pixels&quot;</span>)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                              <span class="cf">for</span> r <span class="kw">in</span> result);</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>                       xtics<span class="op">=</span><span class="st">&quot;set xtics 10, 10, 50&quot;</span>,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>                       ytics<span class="op">=</span><span class="st">&quot;set ytics 10, 10, 50&quot;</span>)</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
</div>
<div class="named-code-block">
<div class="code-block-title">
file:figures.mk
</div>
<pre class="make"><code>.RECIPEPREFIX = &gt;
.PHONY: all _all

fig := docs/fig

all: _all

&lt;&lt;build&gt;&gt;

_all: $(targets)</code></pre>
</div>
<div class="named-code-block">
<div class="code-block-title">
«build»
</div>
<pre class="make"><code>targets += $(fig)/burgess2013-fig3.svg
targets += $(fig)/burgess2013-long-times.svg

docs/fig/burgess2013-fig3.svg: src/figures/ca.jl
&gt; julia --project=. -e &#39;include(&quot;$&lt;&quot;); plot(&quot;$@&quot;)&#39;

docs/fig/burgess2013-long-times.svg: src/figures/ca.jl
&gt; julia --project=. -e &#39;include(&quot;$&lt;&quot;); plot_long_times(&quot;$@&quot;)&#39;</code></pre>
</div>
</details>
<div class="named-code-block">
<div class="code-block-title">
file:src/Burgess2013/Production.jl
</div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode julia"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> Production</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">..Config</span>: Species, Iₖ, k, gₘ</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;</span>carbonate<span class="op">-</span>production<span class="op">&gt;&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">production_rate</span>(I₀<span class="op">::</span><span class="dt">Float64</span>, s<span class="op">::</span><span class="dt">Species</span>, w<span class="op">::</span><span class="dt">Float64</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">g</span>(<span class="fu">gₘ</span>(s), I₀, <span class="fu">Iₖ</span>(s), <span class="fu">k</span>(s), w)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">production_rate</span>(I₀<span class="op">::</span><span class="dt">Float64</span>, specs<span class="op">::</span><span class="dt">Vector{Species}</span>, spec_map<span class="op">::</span><span class="dt">Matrix{Int}</span>, w<span class="op">::</span><span class="dt">Matrix{Int}</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">production_rate</span>.(I₀, <span class="bu">Iterators</span>.<span class="fu">map</span>(i <span class="op">-&gt;</span> specs[i], spec_map), w)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
</div>
<section id="crowding" class="level3">
<h3>Crowding</h3>
<p>In crowded areas carbonate production rates are reduced. For cells
where</p>
<p><span class="math display">\[n_{min} \le n \le n_{opt}\]</span></p>
<p>and</p>
<p><span class="math display">\[n_{opt} \le n \le n_{max}\]</span></p>
<p>(<span class="math inline">\(n_{min}\)</span> and <span
class="math inline">\(n_{max}\)</span> for living cells are 4 and
10)</p>
<p>we have a linear increase and linear decrease of production rate
(i.e. a triangle function).</p>
</section>
</section>
<section id="subsidence" class="level2">
<h2>Subsidence</h2>
<p>Subsidence refers to gradual lowering or lifting of the underlying
floor bed. This could be either sea level rise due to climate change,
but also tectonic activity. Sea level also changes according to a given
recipe with say three sinusoidals (e.g. Milankovich cycles). When a cell
gets “subaerial exposure”, i.e. the water level drops below the cell
elevation (stupid jargon), accumulation stops and the cell becomes
dormant. On reflooding, the cell resumes activity. From the text it is
not entirely clear, but I think deactivated cells don’t take part in the
CA, so they count as dead neighbours.</p>
<ul>
<li><a
href="http://strata.uga.edu/sequence/accommodation.html">reference on
accommodation</a>, also links to a model called <a
href="https://github.com/mcflugen/sedflux">SedFlux</a>.</li>
</ul>
<p><span class="math display">\[T + E = S + W\]</span></p>
<p>Saying Tectonic subsidence plus Eustatic sea-level change equals
Sedimentation plus change in Water depth.</p>
</section>
<section id="steps" class="level2">
<h2>Steps</h2>
<ol type="1">
<li>Update waterdepth, given subsidence</li>
<li>Update sea level elevation, given eustatics</li>
<li>Run CA</li>
<li>Compute thickness of carbonate production</li>
<li>Compute sediment transport</li>
</ol>
<p>We need to keep a state with the following components:</p>
<ul>
<li>height map</li>
<li>species</li>
<li>global time, implying:
<ul>
<li>sea level and subsidence</li>
</ul></li>
</ul>
<p>Every cycle we may export a layer of sediment to archive.</p>
</section>
</section>
</div>

<div id="menu" class="col-3 col-s-3 menu"><nav id="TOC" role="doc-toc">
<ul>
<li><a href="#carbocat-2013" id="toc-carbocat-2013">CarboCAT 2013</a>
<ul>
<li><a href="#cellular-automaton" id="toc-cellular-automaton">Cellular
Automaton</a></li>
<li><a href="#subsidence" id="toc-subsidence">Subsidence</a></li>
<li><a href="#steps" id="toc-steps">Steps</a></li>
</ul></li>
</ul>
</nav></div>
</div>

<div class="footer">
</div>

</body>
</html>
